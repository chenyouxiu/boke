## OpenStack-Python API

### 一、Json形式

#### 1.user_manager

在自行搭建的 OpenStack 私有云平台或提供的 all-in-one 平台上，根据 http 服务中提供 的 Python-api.tar.gz 软件包，完成 python3.6 软件和依赖库的安装。在 controller 节点的/root 2021 年职业院校技能大赛“云计算”赛项 赛卷 目录下创建 create_user.py 文件，编写 python 代码对接 OpenStack API，完成用户的创建。要 求在 OpenStack 私有云平台中创建用户 chinaskill，描述为“API create user!”。执行完代码 要求输出“用户创建成功”。

```python
[root@controller ~]# cat create_user.py     
import json,requests
auth_url_token="http://192.168.100.126:35357/v3/auth/tokens"
headers={}
headers["Content-Type"]="application/json"
body={
    "auth":{
        "identity":{
            "methods":["password"],
            "password":{
                "user":{
                    "id":"7d35a5c7f9a14290b2c3e5d844bfe5e0",
                    "password":"000000"
                }
            }
        },"scope":{
            "project":{
                "id":"c4c292366a034567b77da2736b9a97af"
            }
        }
    }
}
def get_token():
    results=requests.post(url=auth_url_token,data=json.dumps(body),headers=headers).headers["X-Subject-Token"]
    return results
print(get_token())
#create_user()
headers["X-Auth-Token"]=get_token()
create_user_url="http://192.168.100.126:35357/v3/users"
def create_user():
    get_user=requests.get(url="http://192.168.100.126:35357/v3/users",headers=headers).json()["users"]
    for i in get_user:
        if i["name"]=="chinaskill":
            print(requests.delete(url="http://192.168.100.126:35357/v3/users/"+i["id"],headers=headers))
    users={
        "user":{
            "name":"chinaskill",
            "domain_id":"b1e3187d284a4f4fbb057452d7250088",
            "description":"API create user!"
        }
    }
    create_user=requests.post(url=create_user_url,data=json.dumps(users),headers=headers).json()
    print(create_user)
    print("用户创建成功！")
create_user()
```

输出结果：

```shell
[root@controller ~]# python3 create_user.py 
gAAAAABiUSXbCVbIeSfc-atnv_FI7cW9WqyABIafd8zrAAQRRXB2Y0x7tsdp1JhzUE8f1AHwsE-pV-j-Rq3d2XuqyMN5zUGxW8p0udlYkyVwzM3tojeBKlo0hEFGQY2B4XUCg2FJ-a4DY-ogFbU0_eMKnZ5jaO8gkRMFvkD-HHGblpeaQkUvHcc
<Response [204]>
{'user': {'description': 'API create user!', 'name': 'chinaskill', 'domain_id': 'b1e3187d284a4f4fbb057452d7250088', 'enabled': True, 'links': {'self': 'http://192.168.100.126:35357/v3/users/71bdc86c0de84d66a861413ed8e088c5'}, 'options': {}, 'id': '71bdc86c0de84d66a861413ed8e088c5', 'password_expires_at': None}}
用户创建成功！
```



#### 2.flavor_manager

 在自行搭建的 OpenStack私有云平台或提供的 all-in-one 平台上。在 controller 节点的/root 目录下创建 create_flavor.py 文件，在该文件中编写 python 代码对接 openstack api，要求在 openstack 私有云平台上创建一个云主机类型，名字为 pvm_flavor、vcpu 为 1 个、内存为 1024m、硬盘为 20G、ID 为 9999。执行完代码要求输出“云主机类型创建成功”。

```python
[root@controller ~]# cat create_flavor.py     
import json,requests
auth_url_token="http://192.168.100.126:35357/v3/auth/tokens"
headers={}
headers["Content-Type"]="application/json"
body={
    "auth":{
        "identity":{
            "methods":["password"],
            "password":{
                "user":{
                    "id":"7d35a5c7f9a14290b2c3e5d844bfe5e0",
                    "password":"000000"
                }
            }
        },"scope":{
            "project":{
                "id":"c4c292366a034567b77da2736b9a97af"
            }
        }
    }
}
def get_token():
    results=requests.post(url=auth_url_token,data=json.dumps(body),headers=headers).headers["X-Subject-Token"]
    return results
print(get_token())
#create_user()
headers["X-Auth-Token"]=get_token()
create_flavor_url="http://192.168.100.126:8774/v2.1/flavors"
def create_flavor():
    get_flavors=requests.get(url="http://192.168.100.126:8774/v2.1/flavors",headers=headers).json()["flavors"]
    for i in get_flavors:
        if i["name"]=="pvm_flavor":
            print(requests.delete(url="http://192.168.100.126:8774/v2.1/flavors/"+i["id"],headers=headers))
    flavors={
        "flavor":{
            "name":"pvm_flavor",
            "vcpus":"1",
            "ram":"1024",
            "disk":"20",
            "id":"9999"
        }
    }
    create_flavor=requests.post(url=create_flavor_url,data=json.dumps(flavors),headers=headers).json()
    print(create_flavor)
    print("云主机类型创建成功！")
create_flavor()

```

输出

```shell
[root@controller ~]# python3 create_flavor.py 
gAAAAABiUShKsD8CGvMgu92zp8ooiMFwWLTNtbr1w-LHMqrSkKinZ4nqFJBk1YUQAv9HgvM6WNuK6uVMI2am04y01mwwPvkTy6tAOaN_UHdIizkU9mG8NyQ4djacGp_14r7s84FIR7BeCBc40GLAcgy3m1GXi1d4cEoAhK8oNthQn1DzJqpYhw4
<Response [202]>
{'flavor': {'name': 'pvm_flavor', 'links': [{'href': 'http://192.168.100.126:8774/v2.1/flavors/9999', 'rel': 'self'}, {'href': 'http://192.168.100.126:8774/flavors/9999', 'rel': 'bookmark'}], 'ram': 1024, 'OS-FLV-DISABLED:disabled': False, 'vcpus': 1, 'swap': '', 'os-flavor-access:is_public': True, 'rxtx_factor': 1.0, 'OS-FLV-EXT-DATA:ephemeral': 0, 'disk': 20, 'id': '9999'}}
云主机类型创建成功！
```



#### 3.network_manager

在自行搭建的 OpenStack私有云平台或提供的 all-in-one 平台上。在 controller 节点的/root 目录下创建 create_network.py 文件，编写 python 代码对接 OpenStack API，完成网络的创建。 要求：（1）为平台创建内部网络 pvm_int，子网名称为 pvm_intsubnet;

（2）设置云主机网 络子网 IP 网段为 192.168.x.0/24（其中 x 是考位号），网关192.168.x.1（如果存在同名内 网，代码中需先进行删除操作）。执行完代码要求输出“网络创建成功”。

```python
[root@controller ~]# cat create_network.py     
import json,requests
auth_url_token="http://192.168.100.126:35357/v3/auth/tokens"
headers={}
headers["Content-Type"]="application/json"
body={
    "auth":{
        "identity":{
            "methods":["password"],
            "password":{
                "user":{
                    "id":"7d35a5c7f9a14290b2c3e5d844bfe5e0",
                    "password":"000000"
                }
            }
        },"scope":{
            "project":{
                "id":"c4c292366a034567b77da2736b9a97af"
            }
        }
    }
}
def get_token():
    results=requests.post(url=auth_url_token,data=json.dumps(body),headers=headers).headers["X-Subject-Token"]
    return results
print(get_token())
#create_user()
headers["X-Auth-Token"]=get_token()
create_network_url="http://192.168.100.126:9696/v2.0/networks"
create_subnets_url="http://192.168.100.126:9696/v2.0/subnets"
def create_network():
    get_network=requests.get(url="http://192.168.100.126:9696/v2.0/networks",headers=headers).json()["networks"]
    for i in get_network:
        if i["name"]=="pvm_int":
            print(requests.delete(url="http://192.168.100.126:9696/v2.0/networks/"+i["id"],headers=headers))
    networks={
        "network":{
            "name":"pvm_int",
            "router:external":False,
            "project_id":"c4c292366a034567b77da2736b9a97af",
            "provider:network_type":"vxlan"
        }
    }
    create_network=requests.post(url=create_network_url,data=json.dumps(networks),headers=headers).json()
    print(create_network)
    network_id=create_network["network"]["id"]
    subnets={
        "subnet":{
            "name":"pvm_intsubnet",
            "cidr":"192.168.32.0/24",
            "gateway_ip":"192.168.32.1",
            "ip_version":4,
            "network_id":str(network_id)
        }
    }
    create_subnets=requests.post(url=create_subnets_url,data=json.dumps(subnets),headers=headers).json()
    print(create_subnets)
    print("网络创建成功!")
create_network()

```

输出

```shell
[root@controller ~]# python3 create_network.py 
gAAAAABiUSwrxTyoAqgdkEdg32KQ2dbX_25JKlR4zz3fWdgjChONO09SWRlQVNSrg7Pp4NQf3e0MweQxgLoFZU9Q6j-FsDxCf9X6E8VhzTrqNRRMrI7E9vl9cbAx6a4cdgcMKwSdiaZrZrXalsOyA3FRPBd1dJtTrWoAOjNXkrW125l-r7QJ3MY
<Response [204]>
{'network': {'provider:physical_network': None, 'ipv6_address_scope': None, 'revision_number': 2, 'port_security_enabled': True, 'provider:network_type': 'vxlan', 'id': 'bf68c068-8aac-4cf9-9863-83be4608f221', 'router:external': False, 'availability_zone_hints': [], 'availability_zones': [], 'ipv4_address_scope': None, 'shared': False, 'project_id': 'c4c292366a034567b77da2736b9a97af', 'status': 'ACTIVE', 'subnets': [], 'description': '', 'tags': [], 'updated_at': '2022-04-09T06:48:17Z', 'is_default': False, 'provider:segmentation_id': 108, 'name': 'pvm_int', 'admin_state_up': True, 'tenant_id': 'c4c292366a034567b77da2736b9a97af', 'created_at': '2022-04-09T06:48:17Z', 'mtu': 1450}}
{'subnet': {'service_types': [], 'description': '', 'enable_dhcp': True, 'tags': [], 'network_id': 'bf68c068-8aac-4cf9-9863-83be4608f221', 'tenant_id': 'c4c292366a034567b77da2736b9a97af', 'created_at': '2022-04-09T06:48:17Z', 'dns_nameservers': [], 'updated_at': '2022-04-09T06:48:17Z', 'gateway_ip': '192.168.32.1', 'ipv6_ra_mode': None, 'allocation_pools': [{'start': '192.168.32.2', 'end': '192.168.32.254'}], 'host_routes': [], 'revision_number': 0, 'ip_version': 4, 'ipv6_address_mode': None, 'cidr': '192.168.32.0/24', 'project_id': 'c4c292366a034567b77da2736b9a97af', 'id': '812f0871-473d-460e-8400-4d870b902f0b', 'subnetpool_id': None, 'name': 'pvm_intsubnet'}}
网络创建成功!

```



#### 4.image_manager

在自行搭建的 OpenStack私有云平台或提供的 all-in-one 平台上。在 controller 节点的/root 目录下创建 create_image.py 文件，编写 python 代码对接 OpenStack API，完成镜像的上传。 要求在 OpenStack 私有云平台中上传镜像 cirros-0.3.4-x86_64-disk.img，名字为 pvm_image， disk_format 为 qcow2，container_format 为 bare。执行完代码要求输出“镜像创建成功，id 为:xxxxxx”。

```python
[root@controller ~]# cat create_image.py     
import json,requests
auth_url_token="http://192.168.100.126:35357/v3/auth/tokens"
headers={}
headers["Content-Type"]="application/json"
body={
    "auth":{
        "identity":{
            "methods":["password"],
            "password":{
                "user":{
                    "id":"7d35a5c7f9a14290b2c3e5d844bfe5e0",
                    "password":"000000"
                }
            }
        },"scope":{
            "project":{
                "id":"c4c292366a034567b77da2736b9a97af"
            }
        }
    }
}
def get_token():
    results=requests.post(url=auth_url_token,data=json.dumps(body),headers=headers).headers["X-Subject-Token"]
    return results
print(get_token())
#create_user()
headers["X-Auth-Token"]=get_token()
create_image_url="http://192.168.100.126:9292/v2.0/images"
def create_image():
    get_image=requests.get(url="http://192.168.100.126:9292/v2.0/images",headers=headers).json()["images"]
    for i in get_image:
        if i["name"]=="pvm_image":
            print(requests.delete(url="http://192.168.100.126:9292/v2.0/images/"+i["id"],headers=headers))
    images={
        "name":"pvm_image",
        "disk_format":"qcow2",
        "container_format":"bare"
    }
    create_image=requests.post(url=create_image_url,data=json.dumps(images),headers=headers).json()
    print(create_image)
    image_id=create_image["id"]
    upload_file=create_image["file"]
    upload_image_url="http://192.168.100.126:9292"+upload_file
    headers["Content-Type"]="application/octet-stream"
    upload_image=requests.put(url=upload_image_url,headers=headers,data=open("/root/cirros-0.3.4-x86_64-disk.img","rb"))
    print(upload_image)
    print("镜像创建成功！id:",image_id)
create_image()

```

输出

```shell
[root@controller ~]# python3 create_image.py 
gAAAAABiUS-mqsbbAQto9vIScls9LFIRgoxEbP_Ot0uVZtvtkVfIwvVrjE-zoXMj4UvMosHsCtxMx_kOE6i-yrYiOOgQeZo6x1cFq7aKq9zHCwGZ3jyGlvldSpjJnPnKNLq8QOyX4iMsxrFMNlqmIWTecN9LjJ3I0mwBC6gx_wpgvE2KTlHFh4s
<Response [204]>
{'status': 'queued', 'name': 'pvm_image', 'tags': [], 'container_format': 'bare', 'created_at': '2022-04-09T07:03:05Z', 'size': None, 'disk_format': 'qcow2', 'updated_at': '2022-04-09T07:03:05Z', 'visibility': 'shared', 'self': '/v2/images/f8e8c4cf-ef93-4e2e-9a5a-35a4c43f28f3', 'min_disk': 0, 'protected': False, 'id': 'f8e8c4cf-ef93-4e2e-9a5a-35a4c43f28f3', 'file': '/v2/images/f8e8c4cf-ef93-4e2e-9a5a-35a4c43f28f3/file', 'checksum': None, 'owner': 'c4c292366a034567b77da2736b9a97af', 'virtual_size': None, 'min_ram': 0, 'schema': '/v2/schemas/image'}
<Response [204]>
镜像创建成功！id: f8e8c4cf-ef93-4e2e-9a5a-35a4c43f28f3
```



#### 5.server_manager

在自行搭建的 OpenStack私有云平台或提供的 all-in-one 平台上。在 controller 节点的/root 目录下创建 create_vm.py 文件，编写 python 代码对接 OpenStack API，完成云主机的创建。 要求使用 pvm_image、pvm_flavor、pvm_intsubnet 创建 1 台云主机 pvm1（如果存在同名虚 拟主机，代码中需先进行删除操作）。执行完代码要求输出“创建云主机成功”。

```python
[root@controller ~]# cat create_vm.py     
import json,requests
auth_url_token="http://192.168.100.126:35357/v3/auth/tokens"
headers={}
headers["Content-Type"]="application/json"
body={
    "auth":{
        "identity":{
            "methods":["password"],
            "password":{
                "user":{
                    "id":"7d35a5c7f9a14290b2c3e5d844bfe5e0",
                    "password":"000000"
                }
            }
        },"scope":{
            "project":{
                "id":"c4c292366a034567b77da2736b9a97af"
            }
        }
    }
}
def get_token():
    results=requests.post(url=auth_url_token,data=json.dumps(body),headers=headers).headers["X-Subject-Token"]
    return results
print(get_token())
#create_user()
headers["X-Auth-Token"]=get_token()
create_server_url="http://192.168.100.126:8774/v2.1/servers"
def create_server():
    get_server=requests.get(url="http://192.168.100.126:8774/v2.1/servers",headers=headers).json()["servers"]
    for i in get_server:
        if i["name"]=="pvm1":
            print(requests.delete(url="http://192.168.100.126:8774/v2.1/servers/"+i["id"],headers=headers))
    servers={
        "server":{
            "name":"pvm1",
            "imageRef":"f8e8c4cf-ef93-4e2e-9a5a-35a4c43f28f3",
            "flavorRef":"9999",
            "networks":[{"uuid":"bf68c068-8aac-4cf9-9863-83be4608f221"}]
        }
    }
    create_server=requests.post(url=create_server_url,data=json.dumps(servers),headers=headers).json()
    print(create_server)
    print("云主机创建成功！")
create_server()


```

输出

```shell
[root@controller ~]# python3 create_vm.py 
gAAAAABiUTMXmzwuMfR-9w2z0-pmXpxnARS4v1deH8TIUCS02KUSd4dZKUHLH7rU1_ighYXBRwhm8mreytRk5gtLarZSd8hCsNCiKNUhwh1QjU-gtym_elA-Bo6zaQtHgi_ClLrWxq_SIBqPZmO00Ica1_pTsM7RrPpVHZvTlozTzaHDDT6l2q4
<Response [204]>
{'server': {'security_groups': [{'name': 'default'}], 'OS-DCF:diskConfig': 'MANUAL', 'id': '776735ac-9819-42c8-9344-6641690825dc', 'links': [{'href': 'http://192.168.100.126:8774/v2.1/servers/776735ac-9819-42c8-9344-6641690825dc', 'rel': 'self'}, {'href': 'http://192.168.100.126:8774/servers/776735ac-9819-42c8-9344-6641690825dc', 'rel': 'bookmark'}], 'adminPass': '4JyAjaZY9m3i'}}
云主机创建成功！
```



### 二、SDK形式

OpenStack Python SDK官方文档参见：
https://docs.openstack.org/openstacksdk/latest/user/index.html。
通过OpenStack Python SDK可以编写自动化Python脚本，用于创建和管理Openstack云环境中的资源。SDK实现了Python绑定OpenStack API，这能够让你使用Python实现自动化任务通过调用Python对象，而不用直接调用REST接口。
源代码地址为：https://github.com/openstack/openstacksdk。

Python的OpenStack模块下每种资源提供一个对应的模块实现。安装 OpenStack SDK：

```
$ pip install openstacksdk  
```

查找认证的Endpoint地址：

```
keystone     | identity       | True    | internal  | http://controller:5000/v3/  
```

执行以下代码的机器，需要配置hostname：controller IP。



#### 1.案例参考

```python
################################################
              创建连接Keystone
################################################

方法一：
参考：https://docs.openstack.org/openstacksdk/latest/user/guides/connect.html
import openstack

def create_connection(auth_url, region, project_name, username, password,
                      user_domain, project_domain):
    return openstack.connect(
        auth_url="http://192.168.73.10:5000/v3",
        project_name="admin",
        username="admin",
        password="000000",
        user_domain_name="demo"
    )


方法二：
参考：https://www.cnblogs.com/freshchen/p/11656975.html

from keystoneauth1.identity import v3
from keystoneauth1 import session

def get_keystone_session():
    # auth_url为keystone的endpoint入口，新版本openstack中(Tenant租户改名为project）
    auth = v3.Password(auth_url="http://192.168.73.10:5000/v3", username="admin",password="000000", project_name="admin",user_domain_id="426acfc4c2f5481382e0430c2fb13ec3", project_domain_id="426acfc4c2f5481382e0430c2fb13ec3")
    sess = session.Session(auth=auth)
    return sess
print(get_keystone_session())



OpenStackSDK_API参考：https://www.cnblogs.com/freshchen/p/11656975.html
                     https://blog.csdn.net/weixin_33979203/article/details/92260472


from keystoneauth1.identity import v3
from keystoneauth1 import session

def get_keystone_session():
    # auth_url为keystone的endpoint入口，新版本openstack中(Tenant租户改名为project）
    auth = v3.Password(auth_url="http://192.168.73.10:5000/v3", username="admin",password="000000", project_name="admin",user_domain_id="426acfc4c2f5481382e0430c2fb13ec3", project_domain_id="426acfc4c2f5481382e0430c2fb13ec3")
    sess = session.Session(auth=auth)
    return sess
print(get_keystone_session())

```

博客例子：

```python
1确保已经安装了python
2根据需求安装openstack相关服务调用的python库
pip install python-openstackclient
pip install python-keystoneclient
pip install python-heatclient
pip install python-glanceclient
pip install python-novaclient
pip install python-neutronclient


[root@controller openstack_api]# cat openstackapi.py 
from keystoneauth1.identity import v3
from keystoneauth1 import session
from keystoneauth1 import loading
from keystoneclient.v3 import client as keyclient
from glanceclient import Client
from novaclient import client
from neutronclient.v2_0 import client as ntclient
from heatclient import client as hclient


def get_keystone_session():
    loader = loading.get_plugin_loader('password')
    auth = v3.Password(auth_url="http://192.168.73.10:5000/v3", username="admin",password="000000", project_name="admin",user_domain_id="426acfc4c2f5481382e0430c2fb13ec3", project_domain_id="426acfc4c2f5481382e0430c2fb13ec3")
    sess = session.Session(auth=auth)
    return sess

def get_nova_client():
    sess = get_keystone_session()
    nova = client.Client(2, session=sess)
    return nova

def get_glance_client():
    sess = get_keystone_session()
    glance = Client('2', session=sess)
    return glance

def get_keystone_client():
    sess = get_keystone_session()
    keystone = keyclient.Client(session=sess)
    return keystone

def get_neutron_client():
    sess = get_keystone_session()
    neutron = ntclient.Client(session=sess)
    return neutron

def get_heat_client():
    creds = {}
    creds['username'] = 'admin'
    creds['password'] = '000000'
    creds['auth_url'] = 'http://192.168.73.10:5000/v3'
    creds['project_name'] = 'admin'
    ks_client = keyclient.Client(**creds)
    heat_endpoint = ks_client.service_catalog.url_for(service_type='orchestration', endpoint_type='publicURL')
    heat = hclient.Client('1', heat_endpoint, token=ks_client.auth_token)
    return heat


```

```python
[root@controller openstack_api]# cat keystone.py 
import openstackapi as api

keystone = api.get_keystone_client()
list = keystone.projects.list()
for p in list:
    print(p)
    
    


[root@controller openstack_api]# python3 keystone.py 
<Project description=, domain_id=426acfc4c2f5481382e0430c2fb13ec3, enabled=True, id=0ea628cb7ede436994bb89361c675d4b, is_domain=False, links={'self': 'http://controller:5000/v3/projects/0ea628cb7ede436994bb89361c675d4b'}, name=yuanpeng, options={}, parent_id=426acfc4c2f5481382e0430c2fb13ec3, tags=[]>
<Project description=Service Project, domain_id=426acfc4c2f5481382e0430c2fb13ec3, enabled=True, id=7084c877abbe4050b2d4881e70817028, is_domain=False, links={'self': 'http://controller:5000/v3/projects/7084c877abbe4050b2d4881e70817028'}, name=service, options={}, parent_id=426acfc4c2f5481382e0430c2fb13ec3, tags=[]>
<Project description=Admin Project, domain_id=426acfc4c2f5481382e0430c2fb13ec3, enabled=True, id=a5a1c01b079644b5b7b9b91b82f06e01, is_domain=False, links={'self': 'http://controller:5000/v3/projects/a5a1c01b079644b5b7b9b91b82f06e01'}, name=admin, options={}, parent_id=426acfc4c2f5481382e0430c2fb13ec3, tags=[]>
<Project description=Demo Project, domain_id=426acfc4c2f5481382e0430c2fb13ec3, enabled=True, id=b764f17127b348b18e2f6eca03ee7019, is_domain=False, links={'self': 'http://controller:5000/v3/projects/b764f17127b348b18e2f6eca03ee7019'}, name=demo, options={}, parent_id=426acfc4c2f5481382e0430c2fb13ec3, tags=[]>
```

```python
[root@controller openstack_api]# cat nova.py 
import openstackapi as api

def nova_create_flavor(nova, instance_name):
    nova.servers.create(instance_name)

def show_server_info(nova):
    instances = nova.servers.list()
    for instance in instances:
        print(instance)

def show_flavor_info(nova):
    flavors = nova.flavors.list()
    for flavor in flavors:
        print(flavor)

def get_instance_id(nova, instance_name):
    instances = nova.servers.list()
    for instance in instances:
        if instance.name == instance_name:
            return instance.id

def get_instance(nova, instance_id):
    return nova.servers.get(instance_id)

def get_flavor_id(nova, flavor_name):
    flavors = nova.flavors.list()
    for flavor in flavors:
        if flavor.name == flavor_name:
            return flavor.id

if __name__ == '__main__':
    nova = api.get_nova_client()
    show_server_info(nova)
    show_flavor_info(nova)
    id =  get_instance_id(nova, 'm1.small')
    print(id)
    instance = get_instance(nova,id)
    print('################################')
    print(instance)
```

```
[root@controller openstack_api]# cat glance.py 
import openstackapi as api

def list_image():
    list = glance.images.list()
    for image in list:
        print(image.name, image.id, image.status)

def get_id_by_name(name):
    list = glance.images.list()
    id = ''
    for image in list:
        if image.name == name:
            id = image.id
            return id

if __name__ == "__main__":
    glance = api.get_glance_client()
    print('#######   list  #########')
    list_image()
    name = "test-py-api"
    glance.images.create(name=name, disk_format="qcow2", container_format="bare", is_public="true")
    print('#######   list after create #########')
    list = list_image()
    id = get_id_by_name(name)
    glance.images.upload(id , open('/opt/iaas/images/cirros-0.3.4-x86_64-disk.img', 'rb'))
    print('#######   list after upload qcow2   #########')
#    list_image()
#    glance.images.delete(id)
#    print('#######   list after delete qcow2   #########')
    list_image()
```



#### 2.user、projecct、domain管理

```python
import json,logging
import openstack
#openstack logger
# openstack.enable_logging(debug=True)
#文档地址

# 参考：https://docs.openstack.org/openstacksdk/latest/user/guides/identity.html
# https://docs.openstack.org/openstacksdk/latest/user/index.html
def create_connection(auth_url, user_domain_name, username, password):
    """
    建立连接
    :param auth_url:
    :param user_domain_name:
    :param username:
    :param password:
    :return:
    """
    return openstack.connect(
        auth_url=auth_url,
        user_domain_name=user_domain_name,
        username=username,
        password=password
    )
#user Manager
# 参见文档
# https://docs.openstack.org/openstacksdk/latest/user/guides/identity.html
#openstack.connection.Connection
class user_manager:
    def __init__(self, connect:openstack.connection.Connection):
        self.connect = connect
    def list_users(self):
        """
        get User Resource.list object.
        :return:
        """
        users = self.connect.identity.users()
        #to json
        user_jsons = {}
        for user in users:
            user_jsons[user['name']] = user
        return json.dumps(user_jsons,indent=2)
    # project
    def list_projects(self):
        """
        :return:
        """
        projects = self.connect.identity.projects()
        # to json
        projects_jsons = {}
        for item in projects:
            projects_jsons[item['name']] = item
        return json.dumps(projects_jsons, indent=2)
    #domain
    def list_domains(self):
        items = self.connect.identity.domains()
        # to json
        items_jsons = {}
        for item in items:
            items_jsons[item['name']] = item
        return json.dumps(items_jsons, indent=2)
if __name__ == '__main__':
    # Initialize connection(通过配置文件）
    auth_url = "http://192.168.73.10:5000/v3/"
    username = "admin"
    password = "000000"
    user_domain_name = 'demo'
    conn = create_connection(auth_url, user_domain_name, username, password)
    #查用户
    print("-------users-------")
    user_m = user_manager(conn)
    result = user_m.list_users()
    print(result)
    # 查项目
    print("-------projects-------")
    result = user_m.list_projects()
    print(result)
    # 查域
    print("-------domains-------")
    result = user_m.list_domains()
    print(result)

```

##### 2.1.user管理

```python
import json,logging
import openstack
def create_connection(auth_url, user_domain_name, username, password):
    """
    建立连接
    :param auth_url:
    :param user_domain_name:
    :param username:
    :param password:
    :return:
    """
    return openstack.connect(
        auth_url=auth_url,
        user_domain_name=user_domain_name,
        username=username,
        password=password
    )

class user_manager:
    def __init__(self, connect:openstack.connection.Connection):
        self.connect = connect
#去除同名
    def delete_user(self,user_name):
        user = self.connect.identity.find_user(user_name)
        result = self.connect.identity.delete_user(user)
        return result

    def list_users(self):
        """
        get User Resource.list object.
        :return:
        """
        users = self.connect.identity.users()
        #to json
        user_jsons = {}
        for user in users:
            user_jsons[user['name']] = user
        return json.dumps(user_jsons)
    def create_user(self,user_name,domain_id,description):
        user = self.connect.identity.create_user(
            name=user_name, domain_id=domain_id,description=description
        )
        result = self.connect.wait_for_server(user)
        return json.dumps(result)


if __name__ == '__main__':
    # Initialize connection(通过配置文件）
    auth_url = "http://192.168.73.10:5000/v3/"
    username = "admin"
    password = "000000"
    user_domain_name = 'demo'
    conn = create_connection(auth_url, user_domain_name, username, password)
    #去除同名
    print("-------delete users-------")
    user_m = user_manager(conn)
    result = user_m.delete_user("SDK_User")
    #查用户
    print("-------list users-------")
    result = user_m.list_users()
    print(result)

    #创建用户
    print("------create user-------")
    users = user_m.create_user("SDK_User","426acfc4c2f5481382e0430c2fb13ec3","Python SDK Create User")
    print("users",users)
    print("用户创建成功！")
```



#### 3.云主机类型管理：

```python
[root@controller ~]# cat test2.py 
import json,logging
import openstack
def create_connection(auth_url, user_domain_name, username, password):
    """
    建立连接
    :param auth_url:
    :param user_domain_name:
    :param username:
    :param password:
    :return:
    """
    return openstack.connect(
        auth_url=auth_url,
        user_domain_name=user_domain_name,
        username=username,
        password=password
    )

class flavor_manager:
    def __init__(self, connect):
        self.connect = connect
    def list_flavors(self):
        """
        查询所有云主机类型
        :return:
        """
        #to json
        items = self.connect.compute.flavors()
        flavors_jsons = {}
        for flavor in items:
            flavors_jsons[flavor['name']] = flavor
        return json.dumps(flavors_jsons,indent=2)
    #删除同名
    def delete_flavor(self, flavor_name:str):
        """
        根据名称获取云主机类.
        :return:
        """
        #to json
        flavor = self.connect.compute.find_flavor(flavor_name)
        result = self.connect.compute.delete_flavor(flavor)
        return result

    def create_flavor(self, name, ram, vcpus, disk, id, description):
        flavor = self.connect.compute.create_flavor(
            name=name, ram=ram, vcpus=vcpus, disk=disk, id=id, description=description
        )
        result = self.connect.wait_for_server(flavor)
        return result

if __name__ == '__main__':
    # Initialize connection(通过配置文件）
    auth_url = "http://192.168.73.10:5000/v3/"
    username = "admin"
    password = "000000"
    user_domain_name = 'demo'
    conn = create_connection(auth_url, user_domain_name, username, password)

    # 去除同名
    print("delete flavors--------")
    sdk_m = flavor_manager(conn)
    flavor = sdk_m.delete_flavor("SDK_flavor")

    # 1 查询flavors
    print("list flavors--------")
    flavors = sdk_m.list_flavors()
    print("flavors",flavors)

    print("create flavors--------")
    result = sdk_m.create_flavor("SDK_flavor","1024","2","20","9999", "SDK create flavor")
    print("flavor: ", result)

```

输出

```shell
[root@controller ~]# openstack flavor list
+--------------------------------------+-------------+-------+------+-----------+-------+-----------+
| ID                                   | Name        |   RAM | Disk | Ephemeral | VCPUs | Is Public |
+--------------------------------------+-------------+-------+------+-----------+-------+-----------+
| 08bfcb8d-0b2e-4224-bc43-2906fa57eef7 | C4_8_100_50 |  8192 |  100 |        50 |     4 | True      |
| 1                                    | m1.tiny     |   512 |   10 |         0 |     1 | True      |
| 2                                    | m1.small    |  1024 |   20 |         0 |     1 | True      |
| 3                                    | m1.medium   |  2048 |   40 |         0 |     2 | True      |
| 565bbffc-01e6-4704-b825-82f320e55b5d | C4_8_100    |  8192 |  100 |         0 |     4 | True      |
| 6aa0c448-561c-4be1-b74c-8e17ac9a7b4a | C4_12_100   | 12288 |  100 |         0 |     4 | True      |
| 9999                                 | SDK_flavor  |  1024 |   20 |         0 |     2 | True      |
| f623748a-43df-4987-81a8-7226966072a3 | C2_3_80_100 |  3072 |   80 |       100 |     2 | True      |
+--------------------------------------+-------------+-------+------+-----------+-------+-----------+
[root@controller ~]# openstack flavor show SDK_flavor
+----------------------------+-------------------+
| Field                      | Value             |
+----------------------------+-------------------+
| OS-FLV-DISABLED:disabled   | False             |
| OS-FLV-EXT-DATA:ephemeral  | 0                 |
| access_project_ids         | None              |
| description                | SDK create flavor |
| disk                       | 20                |
| id                         | 9999              |
| name                       | SDK_flavor        |
| os-flavor-access:is_public | True              |
| properties                 |                   |
| ram                        | 1024              |
| rxtx_factor                | 1.0               |
| swap                       |                   |
| vcpus                      | 2                 |
+----------------------------+-------------------+
```



#### 4.网络管理

##### 4.1.创建、查看网络

```python
[root@controller ~]# cat net.py 
import json,logging
import openstack
#openstack logger
# openstack.enable_logging(debug=True)
#文档地址
# https://docs.openstack.org/openstacksdk/latest/user/index.html
def create_connection(auth_url, user_domain_name, username, password):
    """
    建立连接
    :param auth_url:
    :param user_domain_name:
    :param username:
    :param password:
    :return:
    """
    return openstack.connect(
        auth_url=auth_url,
        user_domain_name=user_domain_name,
        username=username,
        password=password,
    )

class network_manager:
    def __init__(self, connect):
        self.connect = connect
    def list_networks(self):
        """
        查询所有网络.
        :return:
        """
        #to json
        items = self.connect.network.networks()
        items_jsons = {}
        for network in items:
            items_jsons[network['name']] = network
        return json.dumps(items_jsons,indent=2)
    def get_network(self, network_name:str):
        """
        跟名称查询网络.
        :return:
        """
        #to json
        network = self.connect.network.find_network(network_name)
        return json.dumps(network)

    # 创建网络
    def create_network(self, name, admin_state_up, shared):
        network = self.connect.network.create_network(
            name=name, admin_state_up=admin_state_up, shared=shared
        )
        resrlt = self.connect.wait_for_server(network)
        return json.dumps(resrlt,indent=4)

if __name__ == '__main__':
    # Initialize connection(通过配置文件）
    auth_url = "http://192.168.73.10:5000/v3/"
    username = "admin"
    password = "000000"
    user_domain_name = 'demo'
    conn = create_connection(auth_url, user_domain_name, username, password)
    print("list networks--------")
    sdk_m = network_manager(conn)
    networks = sdk_m.list_networks()
    print("networks:", networks)

    print("show networks--------")
    snetwork = sdk_m.get_network("extnet")
    print("networks: ",snetwork)

    print("create networks--------")
    cnetwork = sdk_m.create_network("SDK_Network","True", "False")
    print("cnetwork", cnetwork)
```

##### 4.2.绑定并查看子网

```python
[root@controller ~]# cat sub.py 
import json,logging
import openstack
#openstack logger
# openstack.enable_logging(debug=True)
#文档地址
# https://docs.openstack.org/openstacksdk/latest/user/index.html
def create_connection(auth_url, user_domain_name, username, password):
    """
    建立连接
    :param auth_url:
    :param user_domain_name:
    :param username:
    :param password:
    :return:
    """
    return openstack.connect(
        auth_url=auth_url,
        user_domain_name=user_domain_name,
        username=username,
        password=password,
    )

class network_manager:
    def __init__(self, connect):
        self.connect = connect
    def list_networks(self):
        """
        查询所有网络.
        :return:
        """
        #to json
        items = self.connect.network.networks()
        items_jsons = {}
        for network in items:
            items_jsons[network['name']] = network
        return json.dumps(items_jsons,indent=2)
    def get_network(self, network_name:str):
        """
        跟名称查询网络.
        :return:
        """
        #to json
        network = self.connect.network.find_network(network_name)
        return json.dumps(network)

    # 创建网络
#    def create_network(self, name, admin_state_up, shared, description):
#        network = self.connect.network.create_network(
#            name=name, admin_state_up=admin_state_up, shared=shared, description=description
#        )
#        resrlt = self.connect.wait_for_server(network)
#        return resrlt

    # 创建子网
    def create_subnet(self, name, cidr, gateway_ip, ip_version, network_id, description):
        subnet = self.connect.network.create_subnet(
            name=name, cidr=cidr, gateway_ip=gateway_ip, ip_version=ip_version, network_id=network_id, description=description
        )
        resrlt = self.connect.wait_for_server(subnet)
        return resrlt

if __name__ == '__main__':
    # Initialize connection(通过配置文件）
    auth_url = "http://192.168.73.10:5000/v3/"
    username = "admin"
    password = "000000"
    user_domain_name = 'demo'
    conn = create_connection(auth_url, user_domain_name, username, password)
    print("list networks--------")
    sdk_m = network_manager(conn)
    networks = sdk_m.list_networks()
    print("networks:", networks)

    print("show networks--------")
    snetwork = sdk_m.get_network("SDK_Network")
    print("snetwork: ", snetwork)
    

    print("create subnets--------")
    csubnet = sdk_m.create_subnet("SDK_Subnet","192.168.200.0/24","192.168.200.1",4,"a44081b7-651e-4d26-9b1c-9cfbafbe476e", "SDK create Subnet")
    print("csubnet", csubnet)
```

输出

```shell
[root@controller ~]# openstack subnet show SDK_Subnet
+----------------------+--------------------------------------+
| Field                | Value                                |
+----------------------+--------------------------------------+
| allocation_pools     | 192.168.200.2-192.168.200.254        |
| cidr                 | 192.168.200.0/24                     |
| created_at           | 2022-08-18T07:50:23Z                 |
| description          | SDK create Subnet                    |
| dns_nameservers      |                                      |
| dns_publish_fixed_ip | None                                 |
| enable_dhcp          | True                                 |
| gateway_ip           | 192.168.200.1                        |
| host_routes          |                                      |
| id                   | 440fb9da-e9f7-44f5-a138-1f2550724922 |
| ip_version           | 4                                    |
| ipv6_address_mode    | None                                 |
| ipv6_ra_mode         | None                                 |
| name                 | SDK_Subnet                           |
| network_id           | a44081b7-651e-4d26-9b1c-9cfbafbe476e |
| project_id           | a5a1c01b079644b5b7b9b91b82f06e01     |
| revision_number      | 0                                    |
| segment_id           | None                                 |
| service_types        |                                      |
| subnetpool_id        | None                                 |
| tags                 |                                      |
| tenant_id            | a5a1c01b079644b5b7b9b91b82f06e01     |
| updated_at           | 2022-08-18T07:50:23Z                 |
+----------------------+--------------------------------------+

[root@controller ~]# openstack network show SDK_Network 
+---------------------------+--------------------------------------+
| Field                     | Value                                |
+---------------------------+--------------------------------------+
| admin_state_up            | UP                                   |
| availability_zone_hints   |                                      |
| availability_zones        | nova                                 |
| created_at                | 2022-08-18T07:24:21Z                 |
| description               | SDK create netowrk                   |
| dns_domain                | None                                 |
| id                        | a44081b7-651e-4d26-9b1c-9cfbafbe476e |
| ipv4_address_scope        | None                                 |
| ipv6_address_scope        | None                                 |
| is_default                | None                                 |
| is_vlan_transparent       | None                                 |
| mtu                       | 1450                                 |
| name                      | SDK_Network                          |
| port_security_enabled     | True                                 |
| project_id                | a5a1c01b079644b5b7b9b91b82f06e01     |
| provider:network_type     | vxlan                                |
| provider:physical_network | None                                 |
| provider:segmentation_id  | 101                                  |
| qos_policy_id             | None                                 |
| revision_number           | 2                                    |
| router:external           | Internal                             |
| segments                  | None                                 |
| shared                    | False                                |
| status                    | ACTIVE                               |
| subnets                   | 440fb9da-e9f7-44f5-a138-1f2550724922 |
| tags                      |                                      |
| updated_at                | 2022-08-18T07:50:23Z                 |
+---------------------------+--------------------------------------+
```



#### 5.镜像管理

```python
[root@controller mnt]# cat image_manager.py 
import json,logging
import openstack

def create_connection(auth_url, user_domain_name, username, password):
    """
    建立连接
    :param auth_url:
    :param user_domain_name:
    :param username:
    :param password:
    :return:
    """
    return openstack.connect(
        auth_url=auth_url,
        user_domain_name=user_domain_name,
        username=username,
        password=password
    )
class image_manager:
    def __init__(self, connect):
        self.connect = connect
    def list_images(self):
        """
        查询所有镜像
        :return:
        """
        #to json
        items = self.connect.image.images()
        images_jsons = {}
        for image in items:
            images_jsons[image['name']] = image
        return json.dumps(images_jsons,indent=2)
    def delete_image(self, image_name:str):
        """
        查询镜像
        :return:
        """
        #to json
        image = self.connect.image.find_image(image_name)
        reluts = self.connect.image.delete_image(image)
        return reluts

    def upload_image(self, name, is_public, disk_format, container_format, data):
        image = self.connect.image.upload_image(
            name=name, is_public=is_public, disk_format=disk_format, container_format=container_format
            ,data=data
        )
        reluts = self.connect.wait_for_server(image)
        return reluts

if __name__ == '__main__':
    # Initialize connection(通过配置文件）
    auth_url = "http://192.168.73.10:5000/v3/"
    username = "admin"
    password = "000000"
    user_domain_name = 'demo'
    conn = create_connection(auth_url, user_domain_name, username, password)

    # 镜像查找
    print("delete  image-------------")
    sdk_m = image_manager(conn)
    reluts = sdk_m.delete_image("SDK_image")
    print("iamges: ", reluts)

    # 镜像查询
    print("list image-------------")
    items = sdk_m.list_images()
    print("image:", items)

    #镜像上传
    print("upload  image-------------")
    reluts = sdk_m.upload_image("SDK_image","True","qcow2","bare",open('/opt/iaas/images/cirros-0.3.4-x86_64-disk.img', 'rb'))
    print(reluts)
```

输出

```shell
[root@controller ~]# openstack image list
+--------------------------------------+----------------+--------+
| ID                                   | Name           | Status |
+--------------------------------------+----------------+--------+
| eb3d36f1-41dc-4692-a0ab-9363ac286546 | CentOS7.5-1804 | active |
| 221afb3f-a96e-4479-948a-49f6d7c9f957 | CentOS7.9-2009 | active |
| 3e91d133-95ce-47c4-9717-23085ff5272f | SDK_image      | active |
| 4a50b098-aecf-4f83-8b6f-9aeca484550c | test-py-api    | active |
+--------------------------------------+----------------+--------+
[root@controller ~]# openstack image show SDK_image 
+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field            | Value                                                                                                                                                                                                        |
+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| checksum         | ee1eca47dc88f4879d8a229cc70a07c6                                                                                                                                                                             |
| container_format | bare                                                                                                                                                                                                         |
| created_at       | 2022-08-18T13:14:24Z                                                                                                                                                                                         |
| disk_format      | qcow2                                                                                                                                                                                                        |
| file             | /v2/images/3e91d133-95ce-47c4-9717-23085ff5272f/file                                                                                                                                                         |
| id               | 3e91d133-95ce-47c4-9717-23085ff5272f                                                                                                                                                                         |
| min_disk         | 0                                                                                                                                                                                                            |
| min_ram          | 0                                                                                                                                                                                                            |
| name             | SDK_image                                                                                                                                                                                                    |
| owner            | a5a1c01b079644b5b7b9b91b82f06e01                                                                                                                                                                             |
| properties       | is_public='True', os_hash_algo='sha512', os_hash_value='1b03ca1bc3fafe448b90583c12f367949f8b0e665685979d95b004e48574b953316799e23240f4f739d1b5eb4c4ca24d38fdc6f4f9d8247a2bc64db25d6bbdb2', os_hidden='False' |
| protected        | False                                                                                                                                                                                                        |
| schema           | /v2/schemas/image                                                                                                                                                                                            |
| size             | 13287936                                                                                                                                                                                                     |
| status           | active                                                                                                                                                                                                       |
| tags             |                                                                                                                                                                                                              |
| updated_at       | 2022-08-18T13:14:25Z                                                                                                                                                                                         |
| visibility       | shared                                                                                                                                                                                                       |
+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
```



#### 6.云主机管理

```python
[root@controller ~]# cat compute_manager.py 
import json, logging
import openstack


# openstack logger
# openstack.enable_logging(debug=True)
# 文档地址
# https://docs.openstack.org/openstacksdk/latest/user/index.html
def create_connection(auth_url, user_domain_name, username, password):
    """
    建立连接
    :param auth_url:
    :param user_domain_name:
    :param username:
    :param password:
    :return:
    """
    return openstack.connect(
        auth_url=auth_url,
        user_domain_name=user_domain_name,
        username=username,
        password=password,
    )


# user Manager
# 参见文档
# https://docs.openstack.org/openstacksdk/latest/user/guides/identity.html
# openstack.connection.Connection
# 云主机管理
class server_manager:
    def __init__(self, connect):
        self.connect = connect

    def delete_server(self, server_name:str):
        """
        删除云主机
        :param server_name:
        :return:
        """
        server = self.connect.compute.find_server(server_name)
        result = self.connect.compute.delete_server(server=server.id)
        return result

    def list_servers(self):
        """
        查询所有云主机.
        :return:
        """
        # to json
        items = self.connect.compute.servers()
        server_jsons = {}
        for server in items:
            server_jsons[server['name']] = server
            # return ""
        return items  # json.dumps(server_jsons,indent=2,skipkeys=True)

    def create_server(self, server_name, image_name, flavor_name, networ_name):
        """
        create a server.
        :param server_name:
        :param image_name:
        :param flavor_name:
        :param networ_name:
        :return:
        """
        image = self.connect.compute.find_image(image_name)
        flavor = self.connect.compute.find_flavor(flavor_name)
        network = self.connect.network.find_network(networ_name)
        server = self.connect.compute.create_server(
            name=server_name, image_id=image.id, flavor_id=flavor.id,
            networks=[{"uuid": network.id}])
        result = self.connect.compute.wait_for_server(server)
        return result  # json.dumps(result,indent=2,skipkeys=True)

if __name__ == '__main__':
    # Initialize connection(通过配置文件）
    auth_url = "http://192.168.73.10:5000/v3/"
    username = "admin"
    password = "000000"
    user_domain_name = 'demo'
    conn = create_connection(auth_url, user_domain_name, username, password)
    # 6 删除云主机
    sdk_m = server_manager(conn)
    result = sdk_m.delete_server("test_song")
    print("servers:", result)

    # 4 查询 云主机
    sdk_m = server_manager(conn)
    servers = sdk_m.list_servers()
    print("servers:", servers)

    # 5 创建云主机
    print("creat server--------")
    servers = sdk_m.create_server("test_song", "test-py-api", "m1.small", "ext-int-1")
    print("servers:", servers)
```

输出

```shell
[root@controller ~]# source /etc/keystone/admin-openrc.sh 
[root@controller ~]# openstack server list
+--------------------------------------+-----------+--------+----------------------------+-------------+------------+
| ID                                   | Name      | Status | Networks                   | Image       | Flavor     |
+--------------------------------------+-----------+--------+----------------------------+-------------+------------+
| d48bb937-e1ec-4d4f-b039-25ad218cf90a | test_song | ACTIVE | ext-int-1=10.0.0.163       | test-py-api | m1.small   |
| d5faedd7-f899-4be7-9384-64ebfacd45be | test      | ACTIVE | SDK_Network=192.168.200.75 | SDK_image   | SDK_flavor |
+--------------------------------------+-----------+--------+----------------------------+-------------+------------+
[root@controller ~]# openstack server show test_song
+-------------------------------------+----------------------------------------------------------+
| Field                               | Value                                                    |
+-------------------------------------+----------------------------------------------------------+
| OS-DCF:diskConfig                   | MANUAL                                                   |
| OS-EXT-AZ:availability_zone         | nova                                                     |
| OS-EXT-SRV-ATTR:host                | controller                                               |
| OS-EXT-SRV-ATTR:hypervisor_hostname | controller                                               |
| OS-EXT-SRV-ATTR:instance_name       | instance-00000019                                        |
| OS-EXT-STS:power_state              | Running                                                  |
| OS-EXT-STS:task_state               | None                                                     |
| OS-EXT-STS:vm_state                 | active                                                   |
| OS-SRV-USG:launched_at              | 2022-08-19T02:13:52.000000                               |
| OS-SRV-USG:terminated_at            | None                                                     |
| accessIPv4                          |                                                          |
| accessIPv6                          |                                                          |
| addresses                           | ext-int-1=10.0.0.163                                     |
| config_drive                        |                                                          |
| created                             | 2022-08-19T02:13:45Z                                     |
| flavor                              | m1.small (2)                                             |
| hostId                              | f31619e7663dceaf419899cc6058002a646ad10b8441032c12778987 |
| id                                  | d48bb937-e1ec-4d4f-b039-25ad218cf90a                     |
| image                               | test-py-api (4a50b098-aecf-4f83-8b6f-9aeca484550c)       |
| key_name                            | None                                                     |
| name                                | test_song                                                |
| progress                            | 0                                                        |
| project_id                          | a5a1c01b079644b5b7b9b91b82f06e01                         |
| properties                          |                                                          |
| security_groups                     | name='default'                                           |
| status                              | ACTIVE                                                   |
| updated                             | 2022-08-19T02:13:52Z                                     |
| user_id                             | 5a2af27b580541d391a10cfe538799f3                         |
| volumes_attached                    |                                                          |
+-------------------------------------+----------------------------------------------------------+
```



### 三、restful形式

接口官网：https://docs.openstack.org/api-ref/identity/。
当前版本为V3.0.网站为：https://docs.openstack.org/api-ref/identity/v3/index.html
Identity服务生成访问OpenStack服务REST API的认证令牌。客户端通过向身份验证服务提供有效凭据来获取此令牌（Token）和其他服务API的URL端点。
每次向OpenStack服务请求REST API时，都需要在X-Auth-Token请求头中提供自己的认证令牌（Token）。
和大多数OpenStack项目一样，OpenStack Identity通过基于角色访问控制（RBAC）的方法定义策略规则来保护API。
Identity服务配置文件设置存储这些规则的JSON策略文件的名称和位置。
V3 API为所有GET请求实现了HEAD。 每个HEAD请求包含与对应的GET API相同的报头和HTTP状态代码。
以下以用户管理的Python实现案例，展示如何调用认证服务的APIs。

#### 1.用户管理

```python
[root@controller restful]# cat apis_user_manager.py
# Copyright 2021~2022 The Cloud Computing support Teams of ChinaSkills.
import requests,json,time
import logging
#-----------logger-----------
#get logger
logger = logging.getLogger(__name__)
# level
logger.setLevel(logging.DEBUG)
# format
format = logging.Formatter('%(asctime)s %(message)s')
# to console
stream_handler  = logging.StreamHandler()
stream_handler .setFormatter(format)
logger.addHandler(stream_handler )
#-----------logger-----------
def get_auth_token(controller_ip, domain, user, password):
    '''
    :param controller_ip: openstack master ip address
    :param domain: current user's domain
    :param user: user name
    :param password: user password
    :return: keystoen auth Token for current user.
    '''
    try:
        url = f"http://{controller_ip}:5000/v3/auth/tokens"
        body = {
                    "auth": {
                        "identity": {
                            "methods": [
                                "password"
                            ],
                            "password": {
                                "user": {
                                    "domain": {
                                        "name": domain
                                    },
                                    "name": user,
                                    "password": password
                                }
                            }
                        },
                        "scope": {
                            "project": {
                                "domain": {
                                    "name": domain
                                },
                                "name": user
                            }
                        }
                    }
                }
        headers = {
            "Content-Type": "application/json",
        }
        print(body)
        Token = requests.post(url, data=json.dumps(body), headers=headers).headers['X-Subject-Token']
        headers = {
            "X-Auth-Token": Token
        }
        logger.debug(f"获取Token值：{str(Token)}")
        return headers
    except Exception as e:
        logger.error(f"获取Token值失败，请检查访问云主机控制节点IP是否正确？输出错误信息如下：{str(e)}")
        exit(0)
#用户管理
# https://docs.openstack.org/api-ref/identity/v3/index.html#users
class user_manager:
    def __init__(self, handers: dict, resUrl: str):
        self.headers = handers
        self.resUrl = resUrl
    #      POST  /v3/users  Create user
    def create_users(self, user_name, password:str, desc:str):
        """
        create a user with name and password and description.
        :param user_name:
        :param password:
        :param desc:
        :return:
        """
        body = {
            "user": {
                "name": user_name,
                "password": password,
                "description": desc,
            }
        }
        status_code = requests.post(self.resUrl, data=json.dumps(body), headers=self.headers).text
        logger.debug(f"返回状态:{str(status_code)}")
        return status_code
    # /v3/users    # List all users
    def get_users(self):
        """
        :return:
        """
        status_code =  requests.get(self.resUrl, headers=self.headers).text
        logger.debug(f"返回状态:{str(status_code)}")
        return status_code
    def get_user_id(self, user_name):
        """
        get user id by name.
        :param user_name:
        :return:
        """
        result = json.loads(requests.get(self.resUrl, headers=self.headers).text)
        user_name = user_name
        for item in result['users']:
            if item['name'] == user_name:
                return item['id']
        return "NONE"
    def get_user(self, id:str):
        """
        get a flavor by id.
        :return:
        """
        api_url = self.resUrl + "/"+id
        result = json.loads(requests.get(api_url, headers=self.headers).text)
        logger.debug(f"返回信息:{str(result)}")
        return result
    def delete_user(self, id:str):
        """
         delete a user by id.
         :return:
         """
        api_url = self.resUrl + "/" + id
        response = requests.delete(api_url, headers=self.headers)
        # 204 - No ContentThe server has fulfilled the request.
        if response.status_code == 204:
            return {"User itemDeletedSuccess": response.status_code}
        result = json.loads(response.text)
        logger.debug(f"返回信息:{str(result)}")
        return result
        # http://192.168.200.226:8774/v2.1/ get apis version infomation.
    def update_User_password(self, id: str, original_password: str, new_password : str):
        """
        update a flavor desc by id.
        :return:
        """
        self.headers['Content-Type'] = "application/json"
        body = {
            "user": {
                "password": new_password,
                "original_password": original_password
            }
        }
        api_url = self.resUrl + "/" + id + "/password"
        response = requests.post(api_url, data=json.dumps(body), headers=self.headers)
        # Normal response codes: 204 without return text
        if response.status_code == 204 :
            return {"item Update Password Success": response.status_code}
        result = json.loads(response.text)
        logger.debug(f"返回信息:{str(result)}")
        return result

if __name__ == '__main__':
    # 1. openstack allinone （controller ) credentials
    # host ip address
    controller_ip = "192.168.73.10"
    # domain name
    domain = "demo"
    # user name
    user = "admin"
    # user password
    password = "000000"
    headers = get_auth_token(controller_ip,domain,user,password)
    print("headers:", headers)
    #get all user
    user_m = user_manager(headers, f"http://{controller_ip}:5000/v3/users")
    # 1 查询所有
    users = user_m.get_users()
    print("查询所有users:", users)

    #5. 删除同名用户
    id = user_m.get_user_id("user_demo")
    result = user_m.delete_user(id)
    print(f"删除{id}用户:", result)

    # 2 创建
    user = user_m.create_users("user_demo", "passw0rd","A user created by python code.")
    print("创建用户:", user)
    # get user id by name
    id = user_m.get_user_id("user_demo")
    print("User user_demo Id is:", id)
    #3. 使用ID查询
    user = user_m.get_user(id)
    print(f"查询{id}用户:", user)
    # 4. 更新密码
    result = user_m.update_User_password(id, "passw0rd", "8assw52d")
    print(f"更新密码{id}用户:", result)
```

返回值

```shell
[root@controller restful]# python3 apis_user_manager.py 
{'auth': {'identity': {'methods': ['password'], 'password': {'user': {'domain': {'name': 'demo'}, 'name': 'admin', 'password': '000000'}}}, 'scope': {'project': {'domain': {'name': 'demo'}, 'name': 'admin'}}}}
2022-08-18 23:08:50,853 获取Token值：
```



#### 2.云主机类型管理

```python
[root@controller restful]# cat apis_flavor_manager.py 
# Copyright 2021~2022 The Cloud Computing support Teams of ChinaSkills.
import requests,json,time
import logging
#-----------logger-----------
#get logger
logger = logging.getLogger(__name__)
# level
logger.setLevel(logging.DEBUG)
# format
format = logging.Formatter('%(asctime)s %(message)s')
# to console
stream_handler  = logging.StreamHandler()
stream_handler .setFormatter(format)
logger.addHandler(stream_handler )
#-----------logger-----------
def get_auth_token(controller_ip, domain, user, password):
    '''
    :param controller_ip: openstack master ip address
    :param domain: current user's domain
    :param user: user name
    :param password: user password
    :return: keystoen auth Token for current user.
    '''
    try:
        url = f"http://{controller_ip}:5000/v3/auth/tokens"
        body = {
                    "auth": {
                        "identity": {
                            "methods": [
                                "password"
                            ],
                            "password": {
                                "user": {
                                    "domain": {
                                        "name": domain
                                    },
                                    "name": user,
                                    "password": password
                                }
                            }
                        },
                        "scope": {
                            "project": {
                                "domain": {
                                    "name": domain
                                },
                                "name": user
                            }
                        }
                    }
                }
        headers = {
            "Content-Type": "application/json",
        }
        print(body)
        Token = requests.post(url, data=json.dumps(body), headers=headers).headers['X-Subject-Token']
        headers = {
            "X-Auth-Token": Token
        }
        logger.debug(f"获取Token值：{str(Token)}")
        return headers
    except Exception as e:
        logger.error(f"获取Token值失败，请检查访问云主机控制节点IP是否正确？输出错误信息如下：{str(e)}")
        exit(0)
class flavor_manager:
    def __init__(self,handers:dict,resUrl:str):
        self.headers=handers
        self.resUrl=resUrl
    #创建flavor类型
    def create_flavor(self,flavor_name:str,ram,vcpus,disk,id):
        """
        :param flavor_name:
        :param ram:
        :param vcpus:
        :param disk:
        :param id:
        :return status_code:
        """
        self.headers['Content-Type']="application/json"
        body={
            "flavor":{
                "name":flavor_name,
                "ram":ram,
                "vcpus":vcpus,
                "disk":disk,
                "id":id,
            }
        }
        logger.debug(f"创建flavor请求body:{str(body)}")
        status_code = requests.post(self.resUrl, data=json.dumps(body), headers=self.headers).text
        logger.debug(f"返回状态:{str(status_code)}")
        return  status_code
    #获取all flavors
    def get_flavors(self):
        """
        get all flavors
        :return:
        """
        result = json.loads(requests.get(self.resUrl,headers=self.headers).text)
        logger.debug(f"返回信息:{str(result)}")
        return result
        # 获取flavor_id
    def get_flavor(self, id:str):
        """
        get a flavor by id.
        :return:
        """
        api_url = self.resUrl + "/"+id
        result = json.loads(requests.get(api_url, headers=self.headers).text)
        logger.debug(f"返回信息:{str(result)}")
        return result
    def delete_flavor(self, id:str):
        """
        delete a flavor by id.
        :return:
        """
        api_url = self.resUrl + "/"+id
        response = requests.delete(api_url, headers=self.headers)
        #Normal response codes: 202 without return text
        if response.status_code == 202:
            return {"itemDeletedSuccess": response.status_code}
        result = json.loads(response.text)
        logger.debug(f"返回信息:{str(result)}")
        return result
    #http://192.168.200.226:8774/v2.1/ get apis version infomation.
    def update_flavor_desc(self, id: str, desc:str):
        """
        update a flavor desc by id.(需要带小版本号）
        :return:
        """
        # 特别注意：This API is available starting with microversion 2.55.
        self.headers['X-OpenStack-Nova-API-Version'] = "2.55"
        self.headers['Content-Type'] = "application/json"
        body = {
            "flavor": {
                "description": desc
            }
        }
        api_url = self.resUrl + "/" + id
        response = requests.put(api_url, data=json.dumps(body), headers=self.headers)
        # Normal response codes: 202 without return text
        if response.status_code == 202:
            return {"itemUpdateSuccess": response.status_code}
        result = json.loads(response.text)
        logger.debug(f"返回信息:{str(result)}")
        return result
if __name__ == '__main__':
    # 1. openstack allinone （controller ) credentials
    # host ip address
    controller_ip = "192.168.73.10"
    # domain name
    domain = "demo"
    # user name
    user = "admin"
    # user password
    password = "000000"
    headers = get_auth_token(controller_ip,domain,user,password)
    print("headers:", headers)
    #. get token
    flavor_m = flavor_manager(headers, f"http://{controller_ip}:8774/v2.1/flavors")
    # 1 查所有
    flavors = flavor_m.get_flavors()
    print("查询所有flavors:", flavors)
    #
    # 2 如果存在，先删除存在的flavor 100000
    flavor = flavor_m.delete_flavor("100000")
    print("查询id=100000 flavor:", flavor)
    #
    # 3 创建 flavor first 100000
    # # id 是唯一的
    status_code = flavor_m.create_flavor(flavor_name="flavor_small", ram=1024, vcpus=1, disk=10, id=100000)
    print("创建主机类型:", status_code)
    # 4 查询
    flavor = flavor_m.get_flavor("100000")
    print("查询id=100000 flavor:", flavor)
    #
    # 5 更新描述
    status_code = flavor_m.update_flavor_desc("100000", "Update description skill_china")
    print("更新主机类型描述:", status_code)
    # 6 查询
    flavors = flavor_m.get_flavor("100000")
    print("查询所有flavors:", flavors)
    #
    # print("---------finished------------")
```



#### 3.云主机管理

```python
[root@controller restful]# cat apis_compute_manager.py
# Copyright 2021~2022 The Cloud Computing support Teams of ChinaSkills.

import requests, json, time
import logging

# -----------logger-----------
# get logger
logger = logging.getLogger(__name__)
# level
logger.setLevel(logging.DEBUG)
# format
format = logging.Formatter('%(asctime)s %(message)s')
# to console
stream_handler = logging.StreamHandler()
stream_handler.setFormatter(format)
logger.addHandler(stream_handler)


# -----------logger-----------

def get_auth_token(controller_ip, domain, user, password):
    '''
    :param controller_ip: openstack master ip address
    :param domain: current user's domain
    :param user: user name
    :param password: user password
    :return: keystoen auth Token for current user.
    '''

    try:
        url = f"http://{controller_ip}:5000/v3/auth/tokens"
        body = {
            "auth": {
                "identity": {
                    "methods": [
                        "password"
                    ],
                    "password": {
                        "user": {
                            "domain": {
                                "name": domain
                            },
                            "name": user,
                            "password": password
                        }
                    }
                },
                "scope": {
                    "project": {
                        "domain": {
                            "name": domain
                        },
                        "name": user
                    }
                }
            }
        }

        headers = {
            "Content-Type": "application/json",
        }
        print(body)
        Token = requests.post(url, data=json.dumps(body), headers=headers).headers['X-Subject-Token']

        headers = {
            "X-Auth-Token": Token
        }
        logger.debug(f"获取Token值：{str(Token)}")
        return headers
    except Exception as e:
        logger.error(f"获取Token值失败，请检查访问云主机控制节点IP是否正确？输出错误信息如下：{str(e)}")
        exit(0)


# 云主机管理
# https://docs.openstack.org/api-ref/compute/?expanded=#list-servers
class server_manager:
    def __init__(self, handers: dict, resUrl: str):
        self.headers = handers
        self.resUrl = resUrl

        #      POST  v2/servers

    def create_server(self, server_name: str, imageRef, flavorRef, networks_id):
        """
        :param server_name:
        :param container_format:
        :param disk_format:
        :return:
        """
        body = {
            "server": {
                "name": server_name,
                "flavorRef": flavorRef,
                "imageRef": imageRef,
                "networks": [{
                    "uuid": networks_id
                }],
            }
        }

        # 必须内容 name、flavorRef、networks、imageRef

        response = requests.post(self.resUrl, data=json.dumps(body), headers=self.headers)
        logger.debug(response.status_code)
        if response.status_code == 202:
            return {"serverItemCreatedSuccess": response.status_code}

        return response.text


    # 获取glance镜像id
    def get_server_id(self, server_name: str):
        result = json.loads(requests.get(self.resUrl, headers=self.headers).text)
        logger.debug(result)
        for item in result['servers']:
            if (item['name'] == server_name):
                return item['id']
        return ""
    # ----------------------------
    # /v2/servers
    # List servers
    def get_servers(self):
        """

        :return:
        """
        status_code = requests.get(self.resUrl, headers=self.headers).text
        logger.debug(f"返回状态:{str(status_code)}")
        return status_code

    # /v2/servers/{server_id} Show server

    def get_server(self, id: str):
        """
        get a flavor by id.
        :return:
        """
        api_url = self.resUrl + "/" + id
        response = requests.get(api_url, headers=self.headers)
        result = json.loads(response.text)
        logger.debug(f"返回信息:{str(result)}")
        return result

    # /v2/servers/{server_id} Delete server
    def delete_server(self, id: str):
        """
         delete a user by id.
         :return:
         """
        api_url = self.resUrl + "/" + id
        response = requests.delete(api_url, headers=self.headers)

        # 204 - No Content      The server has fulfilled the request.
        if response.status_code == 204:
            return {"server itemDeletedSuccess": response.status_code}

        result = json.loads(response.text)
        logger.debug(f"返回信息:{str(result)}")
        return result

        # http://192.168.200.226:8774/v2.1/ get apis version infomation.


if __name__ == '__main__':
    # 1. openstack allinone （controller ) credentials
    # host ip address
    controller_ip = "192.168.73.10"
    # domain name
    domain = "demo"
    # user name
    user = "admin"
    # user password
    password = "000000"
    headers = get_auth_token(controller_ip, domain, user, password)
    print("headers:", headers)
    server_m = server_manager(headers, f"http://{controller_ip}:8774/v2.1/servers")
    # 1 查所有
    servers = server_m.get_servers()
    print("查询所有servers:", servers)
    print("-----------finished----------")
    
    # 删除云主机之前云平台内有一台同名云主机
    id = server_m.get_server_id(server_name="server_001")
    result = server_m.delete_server(id)
    print(f"删除{id}云主机:", result)

    # 2 创建
    # 通过apis或openstack命令查询网络net1 ID、镜像 cirros ID、主机类型ID m1.tiny 1
    imageRef = "221afb3f-a96e-4479-948a-49f6d7c9f957"
    flavorRef = "3"
    networks_id = "a44081b7-651e-4d26-9b1c-9cfbafbe476e"
    networks_name = "SDK_Network"
    result = server_m.create_server("server_001", imageRef, flavorRef, networks_id)
    print(f"创建 云主机:", result)
    # 2 查询id
    id = server_m.get_server_id(server_name="server_001")
    print("server_001，id为: ", id)
    # 3 查一个云主机
    result = server_m.get_server(id)
    print(f"查询{id}云主机:", result)
```

id查询

```shell
[root@controller ~]# source /etc/keystone/admin-openrc.sh 
[root@controller ~]# openstack image list
+--------------------------------------+----------------+--------+
| ID                                   | Name           | Status |
+--------------------------------------+----------------+--------+
| eb3d36f1-41dc-4692-a0ab-9363ac286546 | CentOS7.5-1804 | active |
| 221afb3f-a96e-4479-948a-49f6d7c9f957 | CentOS7.9-2009 | active |
| 8f8b2081-b4f5-46da-903d-1b2a8442c6c2 | SDK_image      | active |
| 4a50b098-aecf-4f83-8b6f-9aeca484550c | test-py-api    | active |
+--------------------------------------+----------------+--------+
[root@controller ~]# openstack flavor list
+--------------------------------------+--------------+-------+------+-----------+-------+-----------+
| ID                                   | Name         |   RAM | Disk | Ephemeral | VCPUs | Is Public |
+--------------------------------------+--------------+-------+------+-----------+-------+-----------+
| 08bfcb8d-0b2e-4224-bc43-2906fa57eef7 | C4_8_100_50  |  8192 |  100 |        50 |     4 | True      |
| 1                                    | m1.tiny      |   512 |   10 |         0 |     1 | True      |
| 100000                               | flavor_small |  1024 |   10 |         0 |     1 | True      |
| 2                                    | m1.small     |  1024 |   20 |         0 |     1 | True      |
| 3                                    | m1.medium    |  2048 |   40 |         0 |     2 | True      |
| 565bbffc-01e6-4704-b825-82f320e55b5d | C4_8_100     |  8192 |  100 |         0 |     4 | True      |
| 6aa0c448-561c-4be1-b74c-8e17ac9a7b4a | C4_12_100    | 12288 |  100 |         0 |     4 | True      |
| 9999                                 | SDK_flavor   |  1024 |   20 |         0 |     2 | True      |
| f623748a-43df-4987-81a8-7226966072a3 | C2_3_80_100  |  3072 |   80 |       100 |     2 | True      |
+--------------------------------------+--------------+-------+------+-----------+-------+-----------+
[root@controller ~]# 
[root@controller ~]# openstack network list
+--------------------------------------+-------------+--------------------------------------+
| ID                                   | Name        | Subnets                              |
+--------------------------------------+-------------+--------------------------------------+
| a44081b7-651e-4d26-9b1c-9cfbafbe476e | SDK_Network | 440fb9da-e9f7-44f5-a138-1f2550724922 |
| ecb1e4c8-1e0e-4eb2-8c1f-44199714a9bc | extnet      | ffc3427c-4fff-408a-a7a0-bbf1f6935e12 |
| edf73acd-f67b-4f0f-ba41-332ae71c6c56 | ext-int-1   | 4904aa54-688e-4962-b7d0-b5e7679585a1 |
| f0383cb2-ea33-45a7-b010-1593a148a762 | extint-2    | 2769ec0d-b390-476a-8850-0385c5755e07 |
+--------------------------------------+-------------+--------------------------------------+
```



#### 4.镜像管理

```python
[root@controller restful]# cat apis_image_manager.py 
# Copyright 2021~2022 The Cloud Computing support Teams of ChinaSkills.
import requests, json, time
import logging
# -----------logger-----------
# get logger
logger = logging.getLogger(__name__)
# level
logger.setLevel(logging.DEBUG)
# format
format = logging.Formatter('%(asctime)s %(message)s')
# to console
stream_handler = logging.StreamHandler()
stream_handler.setFormatter(format)
logger.addHandler(stream_handler)
# -----------logger-----------
def get_auth_token(controller_ip, domain, user, password):
    '''
    :param controller_ip: openstack master ip address
    :param domain: current user's domain
    :param user: user name
    :param password: user password
    :return: keystoen auth Token for current user.
    '''
    try:
        url = f"http://{controller_ip}:5000/v3/auth/tokens"
        body = {
            "auth": {
                "identity": {
                    "methods": [
                        "password"
                    ],
                    "password": {
                        "user": {
                            "domain": {
                                "name": domain
                            },
                            "name": user,
                            "password": password
                        }
                    }
                },
                "scope": {
                    "project": {
                        "domain": {
                            "name": domain
                        },
                        "name": user
                    }
                }
            }
        }
        headers = {
            "Content-Type": "application/json",
        }
        print(body)
        Token = requests.post(url, data=json.dumps(body), headers=headers).headers['X-Subject-Token']
        headers = {
            "X-Auth-Token": Token
        }
        logger.debug(f"获取Token值：{str(Token)}")
        return headers
    except Exception as e:
        logger.error(f"获取Token值失败，请检查访问云主机控制节点IP是否正确？输出错误信息如下：{str(e)}")
        exit(0)
# 镜像管理
class image_manager:
    def __init__(self, handers: dict, resUrl: str):
        self.headers = handers
        self.resUrl = resUrl
    #POST  v2/images
    def create_image(self, image_name: str, container_format="bare", disk_format="qcow2"):
        """
        :param image_name:
        :param container_format:
        :param disk_format:
        :return:
        """
        body = {
            "container_format": container_format,
            "disk_format": disk_format,
            "name": image_name
        }
        response = requests.post(self.resUrl, data=json.dumps(body), headers=self.headers)
        logger.debug(response.status_code)
        if response.status_code == 201:
            return {"ImageItemCreatedSuccess": response.status_code}
        return response.text
    # 获取glance镜像id
    def get_image_id(self, image_name: str):
        result = json.loads(requests.get(self.resUrl, headers=self.headers).text)
        logger.debug(result)
        for item in result['images']:
            if (item['name'] == image_name):
                return item['id']
    # 上传glance镜像
    # Image data¶ Uploads and downloads raw image data.
    # These operations may be restricted to administrators. Consult your cloud operator’s documentation for details.
    # /v2/images/{image_id}/file
    # 镜像可以重名
    def upload_iamge_data(self, image_id: str, file_path=""):
        """
        :param image_id:
        :param file_path:
        :return:
        """
        self.resUrl = self.resUrl + "/" + image_id + "/file"
        self.headers['Content-Type'] = "application/octet-stream"
        response = requests.put(self.resUrl, data=open(file_path, 'rb').read(), headers=self.headers)
        logger.debug(response.status_code)
        if response.status_code == 204:
            return {"ImageItemCreatedSuccess": response.status_code}
        return response.text
    # ----------------------------
    # /v2/images
    # List images
    def get_images(self):
        """
        :return:
        """
        status_code = requests.get(self.resUrl, headers=self.headers).text
        logger.debug(f"返回状态:{str(status_code)}")
        return status_code
    # /v2/images/{image_id} Show image
    def get_image(self, id: str):
        """
        get a flavor by id.
        :return:
        """
        api_url = self.resUrl + "/" + id
        response = requests.get(api_url, headers=self.headers)
        result = json.loads(response.text)
        logger.debug(f"返回信息:{str(result)}")
        return result
    # /v2/images/{image_id} Delete image
    def delete_image(self, id: str):
        """
         delete a image by id.
         :return:
         """
        api_url = self.resUrl + "/" + id
        response = requests.delete(api_url, headers=self.headers)
        # 204 - No ContentThe server has fulfilled the request.
        if response.status_code == 204:
            return {"Image itemDeletedSuccess": response.status_code}
        result = json.loads(response.text)
        logger.debug(f"返回信息:{str(result)}")
        return result
        # http://192.168.200.226:8774/v2.1/ get apis version infomation.
if __name__ == '__main__':
    # 1. openstack allinone （controller ) credentials
    # host ip address
    controller_ip = "192.168.73.10"
    # domain name
    domain = "demo"
    # user name
    user = "admin"
    # user password
    password = "000000"
    headers = get_auth_token(controller_ip, domain, user, password)
    print("headers:", headers)
    #  http://controller:9292
    image_m = image_manager(headers, f"http://{controller_ip}:9292/v2/images")
    # 1 查所有
    images = image_m.get_images()
    print("查询所有images:", images)
    # 删除同名镜像  # 删除镜像之前云平台内有一台同名镜像
    id = image_m.get_image_id(image_name="cirros002")
    result = image_m.delete_image(id)
    print(f"删除{id}云主机:", result)

    # 2 创建镜像（注意，镜像允许同名）
    result = image_m.create_image(image_name="cirros002")  # 调用glance-api中创建镜像方法
    print(f"创建cirros002 镜像:", result)
    #    #1.1查询id
    id = image_m.get_image_id(image_name="cirros002")
    print("cirros002镜像的，id为: ", id)
    # 1.2 上传镜像文件
    result = image_m.upload_iamge_data(id, file_path="/opt/iaas/images/cirros-0.3.4-x86_64-disk.img")   #linux上传
#    result = image_m.upload_iamge_data(id, file_path="J:\镜像\竞赛镜像\chinaskills_cloud_iaas_v2.0.3\images\cirros-0.3.4-x86_64-disk.img")      #windows上传
    print(f"上传{id}镜像:", result)
```

返回值

```shell
[root@controller ~]# openstack image list  
+--------------------------------------+----------------+--------+
| ID                                   | Name           | Status |
+--------------------------------------+----------------+--------+
| eb3d36f1-41dc-4692-a0ab-9363ac286546 | CentOS7.5-1804 | active |
| 221afb3f-a96e-4479-948a-49f6d7c9f957 | CentOS7.9-2009 | active |
| 8f8b2081-b4f5-46da-903d-1b2a8442c6c2 | SDK_image      | active |
| afa4b99d-d750-4832-a55a-4d6ab9642770 | cirros002      | active |
| 4a50b098-aecf-4f83-8b6f-9aeca484550c | test-py-api    | active |
+--------------------------------------+----------------+--------+
[root@controller ~]# openstack image show cirros002 
+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field            | Value                                                                                                                                                                                      |
+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| checksum         | ee1eca47dc88f4879d8a229cc70a07c6                                                                                                                                                           |
| container_format | bare                                                                                                                                                                                       |
| created_at       | 2022-08-19T12:00:34Z                                                                                                                                                                       |
| disk_format      | qcow2                                                                                                                                                                                      |
| file             | /v2/images/afa4b99d-d750-4832-a55a-4d6ab9642770/file                                                                                                                                       |
| id               | afa4b99d-d750-4832-a55a-4d6ab9642770                                                                                                                                                       |
| min_disk         | 0                                                                                                                                                                                          |
| min_ram          | 0                                                                                                                                                                                          |
| name             | cirros002                                                                                                                                                                                  |
| owner            | a5a1c01b079644b5b7b9b91b82f06e01                                                                                                                                                           |
| properties       | os_hash_algo='sha512', os_hash_value='1b03ca1bc3fafe448b90583c12f367949f8b0e665685979d95b004e48574b953316799e23240f4f739d1b5eb4c4ca24d38fdc6f4f9d8247a2bc64db25d6bbdb2', os_hidden='False' |
| protected        | False                                                                                                                                                                                      |
| schema           | /v2/schemas/image                                                                                                                                                                          |
| size             | 13287936                                                                                                                                                                                   |
| status           | active                                                                                                                                                                                     |
| tags             |                                                                                                                                                                                            |
| updated_at       | 2022-08-19T12:00:34Z                                                                                                                                                                       |
| visibility       | shared                                                                                                                                                                                     |
+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
```

#### 5.网络管理

```python
[root@controller restful]# cat apis_network_manager.py
# Copyright 2021~2022 The Cloud Computing support Teams of ChinaSkills.
import requests,json,time
import logging
#-----------logger-----------
#get logger
logger = logging.getLogger(__name__)
# level
logger.setLevel(logging.DEBUG)
# format
format = logging.Formatter('%(asctime)s %(message)s')
# to console
stream_handler  = logging.StreamHandler()
stream_handler .setFormatter(format)
logger.addHandler(stream_handler )
#-----------logger-----------
def get_auth_token(controller_ip, domain, user, password):
    '''
    :param controller_ip: openstack master ip address
    :param domain: current user's domain
    :param user: user name
    :param password: user password
    :return: keystoen auth Token for current user.
    '''
    try:
        url = f"http://{controller_ip}:5000/v3/auth/tokens"
        body = {
                    "auth": {
                        "identity": {
                            "methods": [
                                "password"
                            ],
                            "password": {
                                "user": {
                                    "domain": {
                                        "name": domain
                                    },
                                    "name": user,
                                    "password": password
                                }
                            }
                        },
                        "scope": {
                            "project": {
                                "domain": {
                                    "name": domain
                                },
                                "name": user
                            }
                        }
                    }
                }
        headers = {
            "Content-Type": "application/json",
        }
        print(body)
        Token = requests.post(url, data=json.dumps(body), headers=headers).headers['X-Subject-Token']
        headers = {
            "X-Auth-Token": Token
        }
        logger.debug(f"获取Token值：{str(Token)}")
        return headers
    except Exception as e:
        logger.error(f"获取Token值失败，请检查访问云主机控制节点IP是否正确？输出错误信息如下：{str(e)}")
        exit(0)
#用户管理
# https://docs.openstack.org/api-ref/identity/v3/index.html#users
class network_manager:
    def __init__(self, handers: dict, resUrl: str):
        self.headers = handers
        self.resUrl = resUrl
    #      POST  /v3/users  Create user
    def create_network(self, network_name:str, shared, description):
        self.headers['Content-Type']="application/json"
        body={
            "network":{
                "name": network_name,
                "shared": shared,
                "description": description
            }
        }
        status_code = requests.post(self.resUrl, data=json.dumps(body), headers=self.headers).text
        logger.debug(f"返回状态:{str(status_code)}")
        return status_code

    def get_network_id(self, network_name: str):
        result = json.loads(requests.get(self.resUrl, headers=self.headers).text)
        logger.debug(result)
        for item in result['networks']:
            if (item['name'] == network_name):
                return item['id']
        return ""

    def get_networks(self):
        """

        :return:
        """
        status_code = requests.get(self.resUrl, headers=self.headers).text
        logger.debug(f"返回状态:{str(status_code)}")
        return status_code

        # /v2/servers/{server_id} Show server

    def get_network(self, id: str):
        """
        get a flavor by id.
        :return:
        """
        api_url = self.resUrl + "/" + id
        response = requests.get(api_url, headers=self.headers)
        result = json.loads(response.text)
        logger.debug(f"返回信息:{str(result)}")
        return result

    def create_subnet(self, subnet_name:str, cidr, gateway_ip, network_id, ip_version, description):
        self.headers["Content-Type"]="application/json"
        body={
            "subnet":{
                "name": subnet_name,
                "cidr": cidr,
                "gateway_ip": gateway_ip,
                "network_id": network_id,
                "ip_version": ip_version,
                "description": description
            }
        }
        status_code = requests.post(self.resUrl, data=json.dumps(body), headers=self.headers).text
        logger.debug(f"返回状态:{str(status_code)}")
        return status_code



if __name__ == '__main__':
    # 1. openstack allinone （controller ) credentials
    # host ip address
    controller_ip = "192.168.73.10"
    # domain name
    domain = "demo"
    # user name
    user = "admin"
    # user password
    password = "000000"
    headers = get_auth_token(controller_ip,domain,user,password)
    print("headers:", headers)
    #get all user
    network_m = network_manager(headers, f"http://{controller_ip}:9696/v2.0/networks")
    subnet_m = network_manager(headers, f"http://{controller_ip}:9696/v2.0/subnets")

    #创建网络
    result = network_m.create_network(network_name="cihnaskills",shared="False",description="Python create network")
    print(f"创建network:", result)

    # 获取network_id
    id = network_m.get_network_id(network_name="cihnaskills")
    print("network的id为:", id)

    #创建子网
    result = subnet_m.create_subnet(subnet_name="chianskill", cidr="192.168.32.0/24", gateway_ip="192.168.32.1", network_id=id, ip_version="4", description="Python create subnet")
    print(f"创建subnet:", result)
```

返回值

```
[root@controller ~]# source /etc/keystone/admin-openrc.sh 
[root@controller ~]# openstack network list
+--------------------------------------+-------------+--------------------------------------+
| ID                                   | Name        | Subnets                              |
+--------------------------------------+-------------+--------------------------------------+
| 70e351ce-714a-490b-bc63-c94151b750c9 | cihnaskills | a60d24cf-a040-4551-ba03-3d00f6b7358b |
| a44081b7-651e-4d26-9b1c-9cfbafbe476e | SDK_Network | 440fb9da-e9f7-44f5-a138-1f2550724922 |
| ecb1e4c8-1e0e-4eb2-8c1f-44199714a9bc | extnet      | ffc3427c-4fff-408a-a7a0-bbf1f6935e12 |
| edf73acd-f67b-4f0f-ba41-332ae71c6c56 | ext-int-1   | 4904aa54-688e-4962-b7d0-b5e7679585a1 |
| f0383cb2-ea33-45a7-b010-1593a148a762 | extint-2    | 2769ec0d-b390-476a-8850-0385c5755e07 |
+--------------------------------------+-------------+--------------------------------------+
[root@controller ~]# openstack network show cihnaskills
+---------------------------+--------------------------------------+
| Field                     | Value                                |
+---------------------------+--------------------------------------+
| admin_state_up            | UP                                   |
| availability_zone_hints   |                                      |
| availability_zones        | nova                                 |
| created_at                | 2022-08-19T14:06:05Z                 |
| description               | Python create network                |
| dns_domain                | None                                 |
| id                        | 70e351ce-714a-490b-bc63-c94151b750c9 |
| ipv4_address_scope        | None                                 |
| ipv6_address_scope        | None                                 |
| is_default                | None                                 |
| is_vlan_transparent       | None                                 |
| mtu                       | 1450                                 |
| name                      | cihnaskills                          |
| port_security_enabled     | True                                 |
| project_id                | a5a1c01b079644b5b7b9b91b82f06e01     |
| provider:network_type     | vxlan                                |
| provider:physical_network | None                                 |
| provider:segmentation_id  | 102                                  |
| qos_policy_id             | None                                 |
| revision_number           | 2                                    |
| router:external           | Internal                             |
| segments                  | None                                 |
| shared                    | False                                |
| status                    | ACTIVE                               |
| subnets                   | a60d24cf-a040-4551-ba03-3d00f6b7358b |
| tags                      |                                      |
| updated_at                | 2022-08-19T14:06:06Z                 |
+---------------------------+--------------------------------------+
[root@controller ~]# openstack subnet list 
+--------------------------------------+-------------+--------------------------------------+------------------+
| ID                                   | Name        | Network                              | Subnet           |
+--------------------------------------+-------------+--------------------------------------+------------------+
| 2769ec0d-b390-476a-8850-0385c5755e07 | intsubnet-2 | f0383cb2-ea33-45a7-b010-1593a148a762 | 192.168.100.0/24 |
| 440fb9da-e9f7-44f5-a138-1f2550724922 | SDK_Subnet  | a44081b7-651e-4d26-9b1c-9cfbafbe476e | 192.168.200.0/24 |
| 4904aa54-688e-4962-b7d0-b5e7679585a1 | intsubnet-1 | edf73acd-f67b-4f0f-ba41-332ae71c6c56 | 10.0.0.0/24      |
| a60d24cf-a040-4551-ba03-3d00f6b7358b | chianskill  | 70e351ce-714a-490b-bc63-c94151b750c9 | 192.168.32.0/24  |
| ffc3427c-4fff-408a-a7a0-bbf1f6935e12 | extsubnet   | ecb1e4c8-1e0e-4eb2-8c1f-44199714a9bc | 192.168.73.0/24  |
+--------------------------------------+-------------+--------------------------------------+------------------+
[root@controller ~]# openstack subnet show chianskill
+----------------------+--------------------------------------+
| Field                | Value                                |
+----------------------+--------------------------------------+
| allocation_pools     | 192.168.32.2-192.168.32.254          |
| cidr                 | 192.168.32.0/24                      |
| created_at           | 2022-08-19T14:06:06Z                 |
| description          | Python create subnet                 |
| dns_nameservers      |                                      |
| dns_publish_fixed_ip | None                                 |
| enable_dhcp          | True                                 |
| gateway_ip           | 192.168.32.1                         |
| host_routes          |                                      |
| id                   | a60d24cf-a040-4551-ba03-3d00f6b7358b |
| ip_version           | 4                                    |
| ipv6_address_mode    | None                                 |
| ipv6_ra_mode         | None                                 |
| name                 | chianskill                           |
| network_id           | 70e351ce-714a-490b-bc63-c94151b750c9 |
| project_id           | a5a1c01b079644b5b7b9b91b82f06e01     |
| revision_number      | 0                                    |
| segment_id           | None                                 |
| service_types        |                                      |
| subnetpool_id        | None                                 |
| tags                 |                                      |
| tenant_id            | a5a1c01b079644b5b7b9b91b82f06e01     |
| updated_at           | 2022-08-19T14:06:06Z                 |
+----------------------+--------------------------------------+
```













































